---
title: "Eat Out To Help Out"
author: "Barry Bullas"
date: "31/07/2020"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE, warning =FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Check if the required packages are installed, if not install them
list_of_packages <- c("dplyr", "stringr")
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

#Load required packages
lapply(list_of_packages, library, character.only = TRUE)
```

# Eat Out To Help Out
## Data Prep

This aim of this project is to produce a map displaying the establishments that are taking part in HMRC's Eat Out To Help Out (EO2HO) scheme.  The establishment data is provided by HMRC.  The project also uses the National Statistics Postcode Lookup (NSPL) provide free by the Office of National Statistics (ONS).  The NSPL allows us to identify a lattitude and Longitude for the postcodes in the EA2HO data.

https://www.tax.service.gov.uk/eat-out-to-help-out/find-a-restaurant/?_ga=2.159416701.1723075929.1596201136-857574019.1589147008


```{r subset_nspl}
#Load the NSPL dataset which has coordinates for postcodes
#This can be downloaded freely from 
#https://geoportal.statistics.gov.uk/datasets/national-statistics-postcode-lookup-may-2020
nspl <-read.csv('data/NSPL_MAY_2020_UK.csv')

#Keep onlt the columns we need
nspl <- subset(nspl, select = c(pcds,lat, long))

#Rename pcds colum to make join to EO2HO easier
names(nspl) <- c("Postcode", "lat", "lng")

#write to its own csv in case needed again
write.csv(nspl, 'data/nspl_short.csv', row.names = FALSE)
```

```{r load_data}
#load nspl data
nspl <- read.csv('data/nspl_short.csv')

#Load the Eat Out To Help Out (EO2HO) data
eo2ho <- read.csv('data/participating-establishments/restaurants.csv')

#Format the postcodes to match the NSPL data
eo2ho$Postcode<- toupper(str_replace_all(eo2ho$Postcode, " ", ""))

eo2ho$Postcode<-paste(substr(eo2ho$Postcode, 1,nchar(eo2ho$Postcode)-3), substr(eo2ho$Postcode,nchar(eo2ho$Postcode)-2,nchar(eo2ho$Postcode)), sep = " ", collapse = NULL)

#Join EO2HO data to NSPL to get a cordinate for each establishment
eo2ho_coordinates <- merge(eo2ho, nspl, by="Postcode")

#Add address column for popu
eo2ho_coordinates$Popup <- paste(eo2ho_coordinates$Name, eo2ho_coordinates$Line.1, eo2ho_coordinates$Line.2, eo2ho_coordinates$Town, eo2ho_coordinates$County, eo2ho_coordinates$Postcode, sep=", ")

#TODO Remove after testing
eo2ho_coordinates_NE<- eo2ho_coordinates %>% filter(str_detect(Postcode,"^NE"))

#Drop uneeded columns
eo2ho_coordinates <- subset(eo2ho_coordinates, select = c(lat, lng, Popup))
eo2ho_coordinates_NE <- subset(eo2ho_coordinates_NE, select = c(lat, lng, Popup))

#remove the original datasets to free up memory
rm(nspl, eo2ho)

#Write the data to a new csv
write.csv(eo2ho_coordinates,'data/eo2ho_coordinates.csv', row.names = FALSE)
write.csv(eo2ho_coordinates_NE,'data/eo2ho_coordinates_NE.csv', row.names = FALSE)

```
